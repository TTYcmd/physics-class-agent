<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>è¯¾ç¨‹å†…å®¹è¡¥å……</title>
  <link rel="stylesheet" href="css/style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <div class="container">
    <a href="index.html">â¬…ï¸ è¿”å›é¦–é¡µ</a>
    <h2>ğŸ“˜ è¯¾ç¨‹å†…å®¹è¡¥å……</h2>

    <label for="experiment">ğŸ§ª é€‰æ‹©å®éªŒï¼š</label>
    <select id="experiment">
      <option value="" disabled selected>è¯·é€‰æ‹©ä¸€ä¸ªå®éªŒ</option>
      <option value="double_prism">åŒæ£±é•œ</option>
      <option value="youngs_modulus">æ¨æ°æ¨¡é‡</option>
    </select>

    <!-- âœ… ä¿®æ”¹1ï¼šè¾“å…¥æ–‡ä»¶å -->
    <label for="filename">ğŸ“„ PDF æ–‡ä»¶åï¼ˆå¯é€‰ï¼‰ï¼š</label>
    <input type="text" id="filename" placeholder="ä¸å¡«åˆ™é»˜è®¤ä¸º 'å†…å®¹è¡¥å……'" />

    <label>è¯¾ç¨‹å†…å®¹è¡¥å……ï¼ˆæ”¯æŒå›¾æ–‡ï¼‰ï¼š</label>
    <div id="content" contenteditable="true">
      <h3>ä¾‹ï¼šå®éªŒæ­¥éª¤è¯´æ˜</h3>
      <p>åœ¨æ­¤è¾“å…¥æ•™å­¦æ­¥éª¤ã€å›¾ç¤ºè¯´æ˜ç­‰å†…å®¹â€¦â€¦</p>
    </div>

    <label for="user_id">ğŸ‘¤ ä¸Šä¼ ç”¨æˆ· IDï¼š</label>
    <input type="text" id="user_id" placeholder="è¯·è¾“å…¥ç”¨æˆ·ID" />

    <!-- âœ… ä¿®æ”¹2ï¼šè¾“å…¥å¯†ç  -->
    <label for="password">ğŸ”‘ ä¸Šä¼ å¯†ç ï¼š</label>
    <input type="password" id="password" placeholder="è¯·è¾“å…¥ä¸Šä¼ å¯†ç " />

    <button onclick="generateAndUploadPDF()">ğŸ“¤ å¯¼å‡º PDF å¹¶ä¸Šä¼ </button>
    <div id="status"></div>

    <hr />

    <!-- âœ… ä¿®æ”¹3ï¼šç›´æ¥ä¸Šä¼ æ–‡ä»¶ç«¯å£ -->
    <h3>ğŸ“ ç›´æ¥ä¸Šä¼ å·²æœ‰æ–‡ä»¶</h3>
    <input type="file" id="direct_file" />
    <button onclick="directUpload()">ğŸ“¤ ä¸Šä¼ æ–‡ä»¶</button>
  </div>

  <script>
async function generateAndUploadPDF() {
  const experiment = document.getElementById('experiment').value;
  const filenameInput = document.getElementById('filename').value.trim();
  const userId = document.getElementById('user_id').value.trim();
  const password = document.getElementById('password').value.trim();
  const status = document.getElementById('status');
  const content = document.getElementById('content');

  if (!experiment) {
    status.style.color = "red";
    status.innerText = "â— è¯·é€‰æ‹©ä¸€ä¸ªå®éªŒç±»å‹";
    return;
  }

  if (!userId || !password) {
    status.style.color = "red";
    status.innerText = "â— è¯·è¾“å…¥ç”¨æˆ·IDå’Œå¯†ç ";
    return;
  }

  status.style.color = "black";
  status.innerText = "â³ æ­£åœ¨æˆªå›¾å¹¶ç”Ÿæˆ PDF...";

  const pdfFileName = filenameInput || "å†…å®¹è¡¥å……";

  try {
    const canvas = await html2canvas(content, {
      scale: 2,
      useCORS: true
    });

    const imgData = canvas.toDataURL('image/jpeg', 1.0);
    const imgWidth = 210; // A4å®½åº¦ï¼Œmm
    const pageHeight = 297; // A4é«˜åº¦ï¼Œmm
    const imgHeight = canvas.height * imgWidth / canvas.width;
    let heightLeft = imgHeight;

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'a4');
    let position = 0;

    // é¦–é¡µ
    pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
    heightLeft -= pageHeight;

    // åˆ†é¡µ
    while (heightLeft > 0) {
      position = heightLeft - imgHeight;
      pdf.addPage();
      pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
      heightLeft -= pageHeight;
    }

    const blob = pdf.output('blob');

    const formData = new FormData();
    formData.append('file', new File([blob], pdfFileName + '.pdf', { type: 'application/pdf' }));
    formData.append('user_id', userId);
    formData.append('experiment', experiment);
    formData.append('extra_notes', '');
    formData.append('password', password);

    status.innerText = "â³ æ­£åœ¨ä¸Šä¼ åˆ°çŸ¥è¯†åº“...";

    const res = await fetch('/upload-experiment', {
      method: 'POST',
      body: formData
    });

    const result = await res.json();
    if (res.ok) {
      status.style.color = "green";
      status.innerText = result.message;
    } else {
      status.style.color = "red";
      status.innerText = result.message || "âŒ ä¸Šä¼ å¤±è´¥";
    }

  } catch (err) {
    status.style.color = "red";
    status.innerText = "âŒ å‡ºé”™äº†ï¼š" + err.message;
    console.error(err);
  }
}


    async function directUpload() {
      const fileInput = document.getElementById('direct_file');
      const userId = document.getElementById('user_id').value.trim();
      const experiment = document.getElementById('experiment').value;
      const password = document.getElementById('password').value.trim();
      const status = document.getElementById('status');

      if (!fileInput.files.length) {
        status.style.color = "red";
        status.innerText = "â— è¯·é€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶";
        return;
      }

      if (!experiment || !userId || !password) {
        status.style.color = "red";
        status.innerText = "â— è¯·é€‰æ‹©å®éªŒå¹¶å¡«å†™ç”¨æˆ·IDå’Œå¯†ç ";
        return;
      }

      const formData = new FormData();
      formData.append('file', fileInput.files[0]);
      formData.append('user_id', userId);
      formData.append('experiment', experiment);
      formData.append('extra_notes', '');
      formData.append('password', password);

      status.style.color = "black";
      status.innerText = "â³ æ­£åœ¨ä¸Šä¼ æ–‡ä»¶...";

      try {
        const res = await fetch('/upload-experiment', {
          method: 'POST',
          body: formData
        });
        const result = await res.json();
        if (res.ok) {
          status.style.color = "green";
          status.innerText = result.message;
        } else {
          status.style.color = "red";
          status.innerText = result.message || "âŒ ä¸Šä¼ å¤±è´¥";
        }
      } catch (err) {
        status.style.color = "red";
        status.innerText = "âŒ ä¸Šä¼ å‡ºé”™ï¼š" + err.message;
      }
    }
  </script>
</body>
</html>
