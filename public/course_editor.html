<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>å®éªŒè¯¾ç¨‹å®‰æ’</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <a href="index.html">â¬…ï¸ è¿”å›é¦–é¡µ</a>
  <h1>å®éªŒè¯¾ç¨‹å®‰æ’ç¼–è¾‘å™¨</h1>
  <form id="courseForm">
    <div id="printArea">
      <section><h3>æ•™å­¦ç›®çš„</h3><div id="ç›®çš„" class="editor" contenteditable="true"></div></section>
      <section><h3>å†…å®¹å®‰æ’</h3><div id="å†…å®¹" class="editor" contenteditable="true"></div></section>
      <section><h3>æ•™å®¤å®‰æ’</h3><div id="æ•™å®¤" class="editor" contenteditable="true"></div></section>
      <section><h3>æ•™å¸ˆå®‰æ’</h3><div id="æ•™å¸ˆ" class="editor" contenteditable="true"></div></section>
      <section><h3>è€ƒæ ¸æ–¹æ¡ˆ</h3><div id="è€ƒæ ¸" class="editor" contenteditable="true"></div></section>
      <section><h3>è¯¾ç¨‹èµ„æº</h3><div id="èµ„æº" class="editor" contenteditable="true"></div></section>
      <section><h3>å®éªŒæŠ¥å‘Šè¦æ±‚</h3><div id="æŠ¥å‘Š" class="editor" contenteditable="true"></div></section>
      <section><h3>å®éªŒå®¤è¦æ±‚</h3><div id="å®éªŒå®¤" class="editor" contenteditable="true"></div></section>
      <section><h3>æ³¨æ„äº‹é¡¹</h3><div id="æ³¨æ„" class="editor" contenteditable="true"></div></section>
      <section><h3>è¡¥å……</h3><div id="è¡¥å……" class="editor" contenteditable="true"></div></section>
    </div>

    <button type="button" onclick="saveDraft()">ğŸ’¾ ä¿å­˜è‰ç¨¿</button>
    <button type="button" onclick="generateAndUploadPDF()">ğŸ–¨ï¸ ç”Ÿæˆ PDF å¹¶è‡ªåŠ¨ä¸Šä¼ </button>
  </form>

  <div id="uploadSection">
    <hr />
    <h3>å¤‡ç”¨ä¸Šä¼ å…¥å£</h3>
    <input type="file" id="pdfFile" accept="application/pdf" />
    <button onclick="uploadPrintedPDF()">ğŸ“¤ ä¸Šä¼ å·²ä¿å­˜çš„ PDF æ–‡ä»¶</button>
  </div>

  <script>
    const sections = ["ç›®çš„", "å†…å®¹", "æ•™å®¤", "æ•™å¸ˆ", "è€ƒæ ¸", "èµ„æº", "æŠ¥å‘Š", "å®éªŒå®¤", "æ³¨æ„", "è¡¥å……"];

    function saveDraft() {
      const draft = {};
      sections.forEach(id => {
        draft[id] = document.getElementById(id).innerHTML;
      });
      localStorage.setItem("draft", JSON.stringify(draft));
      alert("âœ… è‰ç¨¿å·²ä¿å­˜");
    }

    function loadDraft() {
      const draft = JSON.parse(localStorage.getItem("draft") || "{}");
      sections.forEach(id => {
        if (draft[id]) document.getElementById(id).innerHTML = draft[id];
      });
    }

    async function generateAndUploadPDF() {
      const element = document.getElementById("printArea");
      const opt = {
        margin: 0,
        filename: 'è¯¾ç¨‹å®‰æ’.pdf',
        html2canvas: { scale: 1.5, useCORS: true },
        jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
      };

      // å…‹éš†èŠ‚ç‚¹ä»¥ä¿è¯ç”Ÿæˆ PDF æ—¶ä¸ä¼šå½±å“ç•Œé¢
      const clone = element.cloneNode(true);
      clone.style.width = "800px";
      document.body.appendChild(clone);

      const pdfBlob = await html2pdf().from(clone).set(opt).outputPdf("blob");
      document.body.removeChild(clone);

      const formData = new FormData();
      formData.append("file", new File([pdfBlob], "è¯¾ç¨‹å®‰æ’.pdf", { type: "application/pdf" }));

      const response = await fetch("/upload", {
        method: "POST",
        body: formData
      });

      if (response.ok) {
        const shouldDownload = window.confirm("âœ… PDF å·²ä¸Šä¼ æˆåŠŸï¼æ˜¯å¦ç«‹å³ä¸‹è½½ä¸€ä»½å¤‡ä»½ï¼Ÿ");
        if (shouldDownload) {
          const downloadLink = document.createElement("a");
          downloadLink.href = URL.createObjectURL(pdfBlob);
          downloadLink.download = "è¯¾ç¨‹å®‰æ’.pdf";
          downloadLink.click();
        }
      } else {
        const msg = await response.json();
        alert("âŒ ä¸Šä¼ å¤±è´¥ï¼š" + msg.message);
      }
    }

    async function uploadPrintedPDF() {
      const fileInput = document.getElementById("pdfFile");

      if (!fileInput.files.length) {
        alert("âš ï¸ è¯·å…ˆé€‰æ‹©è¦ä¸Šä¼ çš„ PDF æ–‡ä»¶");
        return;
      }

      const formData = new FormData();
      formData.append("file", fileInput.files[0]);

      const response = await fetch("/upload", {
        method: "POST",
        body: formData
      });

      if (response.ok) {
        alert("âœ… PDF å·²è‡ªåŠ¨ç”Ÿæˆå¹¶æˆåŠŸä¸Šä¼ ï¼");
      } else {
        const msg = await response.json();
        alert("âŒ ä¸Šä¼ å¤±è´¥ï¼š" + msg.message);
      }
    }

    window.onload = loadDraft;
  </script>
</body>
</html>
